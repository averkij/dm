<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<title>Numbers Training - Mode 4</title>
	<style>
		:root {
			--safe-top: env(safe-area-inset-top);
			--safe-right: env(safe-area-inset-right);
			--safe-bottom: env(safe-area-inset-bottom);
			--safe-left: env(safe-area-inset-left);
		}

		html,
		body {
			height: 100%;
		}

		body {
			margin: 0;
			padding: 0;
			background: #000;
			color: #fff;
			display: grid;
			place-items: center;
			overflow: hidden;
			touch-action: manipulation;
			-webkit-tap-highlight-color: transparent;
		}

		#sessionTimer {
			position: fixed;
			top: calc(var(--safe-top) + 8px);
			left: 50%;
			transform: translateX(-50%);
			z-index: 6;
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
			font-weight: 700;
			color: #aaa;
		}

		.main {
			width: calc(100vw - var(--safe-left) - var(--safe-right));
			height: calc(100vh - var(--safe-top) - var(--safe-bottom));
			display: grid;
			place-items: center;
			position: relative;
		}

		#numberDisplay {
			font-size: clamp(64px, 15vw, 192px);
			font-weight: 700;
			color: #000;
			user-select: none;
			background: #fff;
			width: 100%;
			height: 100%;
			display: grid;
			place-items: center;
			text-align: center;
			padding: 20px;
			box-sizing: border-box;
		}

		#textDisplay {
			font-size: 10px;
			font-weight: 400;
			color: #fff;
			user-select: none;
			background: #000;
			background-size: contain;
			background-position: center center;
			background-repeat: no-repeat;
			width: 100%;
			height: 100%;
			display: none;
			display: flex;
			flex-direction: column;
			justify-content: flex-end;
			align-items: flex-start;
			text-align: center;
			padding: 10px;
			box-sizing: border-box;
			line-height: 1.3;
			overflow-y: auto;
		}

		@keyframes fadeInText {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		.interval-list {
			display: flex;
			flex-direction: column;
			gap: 4px;
			width: 100%;
			max-width: 600px;
			opacity: 0;
		}

		.interval-list.fade-in {
			animation: fadeInText 5s ease forwards;
		}

		.interval-item {
			display: grid;
			grid-template-columns: 40px 1fr;
			gap: 12px;
			padding: 2px 5px;
			border-radius: 6px;
			text-align: left;
			color: #555;
			font-size: clamp(12px, 3vw, 18px);
			align-items: center;
		}

		.interval-item.active {
			color: #fff;
			background: #555;
			font-weight: 600;
		}

		.interval-num {
			text-align: right;
			font-variant-numeric: tabular-nums;
			opacity: 0.7;
		}

		#startOverlay {
			position: fixed;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			display: grid;
			place-items: center;
			background: #000;
			z-index: 5;
		}

		.user-label {
			color: #ccc;
			font-size: 14px;
		}

		#healthDot {
			position: fixed;
			top: calc(var(--safe-top) + 6px);
			left: calc(var(--safe-left) + 6px);
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background: #ff3b30;
			box-shadow: 0 0 0 2px rgba(0, 0, 0, .4);
			z-index: 6;
		}

		.user-box {
			display: grid;
			gap: 12px;
			place-items: center;
		}

		.user-input {
			font-size: 18px;
			padding: 10px 12px;
			border-radius: 8px;
			border: 1px solid #444;
			background: #111;
			color: #fff;
			min-width: 240px;
		}

		.user-save {
			appearance: none;
			border: none;
			padding: 10px 16px;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 700;
			cursor: pointer;
			background: #2d7d46;
			color: #fff;
		}

		.start-button {
			appearance: none;
			border: none;
			padding: 14px 28px;
			border-radius: 10px;
			font-size: 20px;
			font-weight: 700;
			cursor: pointer;
			background: #0a84ff;
			color: #fff;
		}

		.start-button:disabled {
			background: #333;
			cursor: default;
		}
	</style>
</head>

<body>
	<div class="main">
		<div id="numberDisplay"></div>
		<div id="textDisplay"></div>
	</div>
	<div id="startOverlay">
		<div id="userGate" class="user-box" hidden>
			<div>Enter user name</div>
			<input id="userInput" class="user-input" type="text" placeholder="Your name" />
			<span id="currentUserLabel" class="user-label"></span>
			<button id="userSave" class="user-save">Continue</button>
		</div>
		<button id="startButton" class="start-button" hidden>Start</button>
	</div>
	<div id="healthDot" aria-hidden="true"></div>
	<div id="sessionTimer" aria-hidden="true" style="display:none">02:00</div>
	<script>
		(function () {
			const HOST = 'https://superminor.ru';

			// Text mapping for numbers 1-52
			const numberTexts = {
				1: "Часть КПП",
				2: "Часть Бухгалтерия",
				3: "Часть Актовый зал",
				4: "Часть Библиотека",
				5: "Часть Медсанчасть",
				6: "Часть Самоволка за санчастью",
				7: "Часть Сарычев (Делопроизводство)",
				8: "Часть Плац",
				9: "Часть Окоп на холме у плаца (Холм)",
				10: "Часть Памятник (Фотография)",
				11: "КП На входе",
				12: "КП Секретка",
				13: "КП Коммутатор",
				14: "КП ЛАЗ Дежурный",
				15: "КП ЛАЗ Громы",
				16: "КП ЛАЗ Койка",
				17: "КП ЛАЗ АТС",
				18: "КП ЛАЗ Комната с ноутбуком",
				19: "КП ЛАЗ Уголок с паяльником",
				20: "КП ЛАЗ Стол",
				21: "КП Зал Дежурный",
				22: "КП Зал Планшеты",
				23: "КП ПРЦ Приемники",
				24: "КП ПРЦ Новый год",
				25: "КП Телеграф",
				26: "КП Подвал, мастерские",
				27: "Часть Вышка",
				28: "Часть Релейка",
				29: "Часть Окоп у релейки",
				30: "Часть Автопарк гаражи",
				31: "Казарма Тумба",
				32: "Казарма Коптерка",
				33: "Казарма Сейф",
				34: "Казарма Левая располага (штанги)",
				35: "Казарма Правая располага (койки)",
				36: "Казарма Бытовка",
				37: "Казарма Сушилка",
				38: "Казарма Канцелярия",
				39: "Казарма Комната досуга",
				40: "Казарма Оружейка",
				41: "Часть Курилка",
				42: "Часть Теплица",
				43: "Часть Спортивный городок",
				44: "Часть Штаб",
				45: "Вторая территория Столовая",
				46: "Вторая территория Казарма",
				47: "Вторая территория Турники",
				48: "Вторая территория Плац",
				49: "Вторая территория Склады",
				50: "Вторая территория Чепок",
				51: "Дембель Уазик до вокзала",
				52: "Дембель Вокзал"
			};

			const numberDisplayEl = document.getElementById('numberDisplay');
			const textDisplayEl = document.getElementById('textDisplay');
			const startOverlay = document.getElementById('startOverlay');
			const startButton = document.getElementById('startButton');
			const userGate = document.getElementById('userGate');
			const userInput = document.getElementById('userInput');
			const userSave = document.getElementById('userSave');
			const currentUserLabel = document.getElementById('currentUserLabel');
			const healthDot = document.getElementById('healthDot');
			const sessionTimerEl = document.getElementById('sessionTimer');

			let lastIndex = -1;
			let isTransitioning = false;
			let pendingIndex = null;

			// Session timing
			let sessionActive = false;
			let tapStartTs = 0;
			let timerHandle = null;
			let sessionTicker = null;
			let sessionDeadlineTs = 0;

			function formatRemaining(ms) {
				var totalSeconds = Math.max(0, Math.ceil(ms / 1000));
				var minutes = Math.floor(totalSeconds / 60);
				var seconds = totalSeconds % 60;
				return String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
			}

			function updateSessionTimerUI() {
				if (!sessionActive) return;
				var remaining = sessionDeadlineTs - Date.now();
				if (remaining <= 0) {
					stopSession("Time's up");
					return;
				}
				sessionTimerEl.textContent = formatRemaining(remaining);
			}

			function restartSessionTimer() {
				if (!sessionActive) return;
				if (timerHandle) {
					clearTimeout(timerHandle);
					timerHandle = null;
				}
				if (sessionTicker) {
					clearInterval(sessionTicker);
					sessionTicker = null;
				}
				sessionDeadlineTs = Date.now() + 120000;
				sessionTimerEl.style.display = 'block';
				updateSessionTimerUI();
				timerHandle = setTimeout(function () { stopSession("Time's up"); }, 120000);
				sessionTicker = setInterval(updateSessionTimerUI, 200);
			}

			function pickNextIndex() {
				let idx;
				do {
					idx = Math.floor(Math.random() * 52) + 1; // 1-52
				} while (idx === lastIndex);
				lastIndex = idx;
				return idx;
			}

			function pickFreshIndex() {
				let idx;
				do {
					idx = Math.floor(Math.random() * 52) + 1; // 1-52
				} while (idx === lastIndex);
				return idx;
			}

			function showNumber() {
				const idx = pickNextIndex();
				pendingIndex = idx;
				numberDisplayEl.textContent = String(idx);
				numberDisplayEl.style.display = 'grid';
				textDisplayEl.style.display = 'none';
				tapStartTs = Date.now();
				restartSessionTimer();
			}

			function stopSession(reasonText) {
				sessionActive = false;
				if (timerHandle) {
					clearTimeout(timerHandle);
					timerHandle = null;
				}
				if (sessionTicker) {
					clearInterval(sessionTicker);
					sessionTicker = null;
				}
				sessionTimerEl.style.display = 'none';
				startButton.textContent = reasonText || 'Time\'s up';
				startButton.disabled = true;
				startOverlay.style.display = 'grid';
			}

			function startSession() {
				sessionActive = true;
				if (timerHandle) { clearTimeout(timerHandle); timerHandle = null; }
				if (sessionTicker) { clearInterval(sessionTicker); sessionTicker = null; }
				showNumber();
			}

			startButton.addEventListener('click', function () {
				startOverlay.style.display = 'none';
				startSession();
			});

			function sendTime(numberStr, elapsedMs, modeValue) {
				try {
					var currentUser = localStorage.getItem('current_user') || null;
					fetch(HOST + '/api/write_time', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ number: Number(numberStr), time: elapsedMs, mode: modeValue, user: currentUser })
					}).catch(function () { });
				} catch (e) { }
			}

			function showGateIfNeeded() {
				var existing = localStorage.getItem('current_user');
				if (!existing) {
					userGate.hidden = false;
					startButton.hidden = true;
					userInput.focus();
				} else {
					userGate.hidden = true;
					startButton.hidden = false;
				}
			}

			function updateUserLabel() {
				var u = localStorage.getItem('current_user') || '';
				currentUserLabel.textContent = u ? ('Current: ' + u) : 'Current: —';
			}

			userSave.addEventListener('click', function () {
				var v = (userInput.value || '').trim();
				if (!v) return;
				localStorage.setItem('current_user', v);
				updateUserLabel();
				showGateIfNeeded();
			});

			userInput.addEventListener('keyup', function (e) {
				if (e.key === 'Enter') userSave.click();
			});

			document.addEventListener('DOMContentLoaded', function () {
				userInput.value = localStorage.getItem('current_user') || '';
				updateUserLabel();
				showGateIfNeeded();
				// Check API health once on load
				(function checkHealthOnce() {
					try {
						fetch(HOST + '/api/health', { method: 'GET', cache: 'no-store' })
							.then(function (r) { return r.ok ? r.json() : Promise.reject(); })
							.then(function (data) {
								if (data && data.status === 'ok') {
									healthDot.style.background = '#2ecc71';
								} else {
									healthDot.style.background = '#ff3b30';
								}
							})
							.catch(function () { healthDot.style.background = '#ff3b30'; });
					} catch (e) {
						healthDot.style.background = '#ff3b30';
					}
				})();
			});

			window.addEventListener('pointerdown', function (ev) {
				if (!sessionActive) return;
				if (ev.isPrimary === false) return;
				if (isTransitioning) return;
				isTransitioning = true;

				var tapElapsed = Math.max(0, Date.now() - tapStartTs);
				var numberForEvent = pendingIndex;

				if (pendingIndex === null) {
					showNumber();
					isTransitioning = false;
					return;
				}

				// Pick background image based on current number: 1–10 -> 1.png, 11–20 -> 2.png, etc.
				if (numberForEvent != null) {
					var bgIndex = Math.floor((numberForEvent - 1) / 10) + 1; // 1-based bucket
					textDisplayEl.style.backgroundImage = 'url("img_bg/' + bgIndex + '.png")';
				}

				// Show text for 2 seconds, then next number
				const start = Math.floor((pendingIndex - 1) / 10) * 10 + 1;
				const end = start + 9;
				let html = '<div class="interval-list">';
				for (let i = start; i <= end; i++) {
					const text = numberTexts[i] || '';
					const isActive = (i === pendingIndex) ? ' active' : '';
					html += `<div class="interval-item${isActive}">
				<span class="interval-num">${i}</span>
				<span class="interval-text">${text}</span>
			</div>`;
				}
				html += '</div>';
				textDisplayEl.innerHTML = html;
				numberDisplayEl.style.display = 'none';
				textDisplayEl.style.display = 'flex';

				// restart fade-in animation on the text list only
				var listEl = textDisplayEl.querySelector('.interval-list');
				if (listEl) {
					listEl.classList.remove('fade-in');
					// force reflow to allow re-adding the class to restart animation
					void listEl.offsetWidth;
					listEl.classList.add('fade-in');
				}

				restartSessionTimer();

				// Send timing for this tap - mode 4
				if (numberForEvent !== null) {
					sendTime(numberForEvent, tapElapsed, 4);
				}

				setTimeout(function () {
					showNumber();
					isTransitioning = false;
				}, 8000);
			});
		})();
	</script>
</body>

</html>