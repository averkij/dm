<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Random Numbers - N Mode</title>
<style>
:root {
	--safe-top: env(safe-area-inset-top);
	--safe-right: env(safe-area-inset-right);
	--safe-bottom: env(safe-area-inset-bottom);
	--safe-left: env(safe-area-inset-left);
}
html, body {
	height: 100%;
}
body {
	margin: 0;
	padding: 0;
	background: #000;
	color: #fff;
	display: grid;
	place-items: center;
	overflow: hidden;
	touch-action: manipulation; /* prevent double-tap zoom */
	-webkit-tap-highlight-color: transparent;
}
/* Session timer centered at the top */
#sessionTimer {
	position: fixed;
	top: calc(var(--safe-top) + 8px);
	left: 50%;
	transform: translateX(-50%);
	z-index: 6;
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
	font-weight: 700;
	color: #aaa;
}
.main {
	width: calc(100vw - var(--safe-left) - var(--safe-right));
	height: calc(100vh - var(--safe-top) - var(--safe-bottom));
	display: grid;
	place-items: center;
	position: relative;
}

#numbersDisplay {
	font-size: clamp(24px, 6vw, 64px);
	font-weight: 700;
	text-align: center;
	line-height: 1.4;
	letter-spacing: 2px;
	user-select: none;
	padding: 20px;
	color: #fff;
	transition: color 0.3s ease;
}

#numbersDisplay.correct {
	color: #2ecc71;
}

#inputSection {
	display: none;
	flex-direction: column;
	align-items: center;
	gap: 20px;
	padding: 20px;
}

#inputSection.visible {
	display: flex;
}

.number-input {
	font-size: 24px;
	padding: 15px 20px;
	border-radius: 8px;
	border: 2px solid #444;
	background: #111;
	color: #fff;
	min-width: 300px;
	text-align: center;
	font-family: monospace;
}

.check-button {
	appearance: none;
	border: none;
	padding: 15px 40px;
	border-radius: 10px;
	font-size: 18px;
	font-weight: 700;
	cursor: pointer;
	background: #0a84ff;
	color: #fff;
}

.check-button:hover {
	background: #0077ed;
}

.digit-display {
	display: inline-block;
	margin: 0 2px;
}

.digit-display.correct {
	color: #2ecc71;
}

.digit-display.incorrect {
	color: #ff3b30;
}

/* Start screen overlay */
#startOverlay {
	position: fixed;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	display: grid;
	place-items: center;
	background: #000;
	z-index: 5;
}
.user-label {
	color: #ccc;
	font-size: 14px;
}

/* Health indicator dot */
#healthDot {
	position: fixed;
	top: calc(var(--safe-top) + 6px);
	left: calc(var(--safe-left) + 6px);
	width: 10px;
	height: 10px;
	border-radius: 50%;
	background: #ff3b30; /* default red until checked */
	box-shadow: 0 0 0 2px rgba(0,0,0,.4);
	z-index: 6;
}
.user-box {
	display: grid;
	gap: 12px;
	place-items: center;
}
.user-input {
	font-size: 18px;
	padding: 10px 12px;
	border-radius: 8px;
	border: 1px solid #444;
	background: #111;
	color: #fff;
	min-width: 240px;
}
.n-input {
	font-size: 18px;
	padding: 10px 12px;
	border-radius: 8px;
	border: 1px solid #444;
	background: #111;
	color: #fff;
	width: 100px;
	text-align: center;
}
.user-save {
	appearance: none;
	border: none;
	padding: 10px 16px;
	border-radius: 8px;
	font-size: 16px;
	font-weight: 700;
	cursor: pointer;
	background: #2d7d46;
	color: #fff;
}
.user-label {
	color: #ccc;
	font-size: 14px;
}
.start-button {
	appearance: none;
	border: none;
	padding: 14px 28px;
	border-radius: 10px;
	font-size: 20px;
	font-weight: 700;
	cursor: pointer;
	background: #0a84ff;
	color: #fff;
}
.start-button:disabled {
	background: #333;
	cursor: default;
}
</style>
</head>
<body>
	<div class="main">
		<div id="numbersDisplay"></div>
		<div id="inputSection">
			<div style="color: #aaa; font-size: 18px;">Enter the numbers you remember:</div>
			<input id="numberInput" class="number-input" type="text" placeholder="0000 0000 0000..." />
			<button id="checkButton" class="check-button">Check</button>
		</div>
	</div>
	<div id="startOverlay">
		<div id="userGate" class="user-box" hidden>
			<div>Enter user name</div>
			<input id="userInput" class="user-input" type="text" placeholder="Your name" />
			<span id="currentUserLabel" class="user-label"></span>
			<div>Number of digits (n)</div>
			<input id="nInput" class="n-input" type="number" min="1" max="100" value="10" />
			<span id="currentNLabel" class="user-label"></span>
			<button id="userSave" class="user-save">Continue</button>
		</div>
		<button id="startButton" class="start-button" hidden>Start</button>
	</div>
	<div id="healthDot" aria-hidden="true"></div>
	<div id="sessionTimer" aria-hidden="true" style="display:none">05:00</div>
<script>
(function() {
	// Backend host for API calls
	const HOST = 'https://superminor.ru';

	const numbersDisplayEl = document.getElementById('numbersDisplay');
	const inputSectionEl = document.getElementById('inputSection');
	const numberInputEl = document.getElementById('numberInput');
	const checkButtonEl = document.getElementById('checkButton');
	const startOverlay = document.getElementById('startOverlay');
	const startButton = document.getElementById('startButton');
	const userGate = document.getElementById('userGate');
	const userInput = document.getElementById('userInput');
	const nInput = document.getElementById('nInput');
	const userSave = document.getElementById('userSave');
	const currentUserLabel = document.getElementById('currentUserLabel');
	const currentNLabel = document.getElementById('currentNLabel');
	const healthDot = document.getElementById('healthDot');
	const sessionTimerEl = document.getElementById('sessionTimer');

	let currentNumbers = [];
	let currentN = 10;
	let isTransitioning = false;
	let memorizationTime = 0; // time to memorize
	let recallStartTs = 0; // when recall phase started

	// Session timing & per-stimulus timing
	let sessionActive = false;
	let tapStartTs = 0; // resets whenever new numbers are shown
	let timerHandle = null;
	let sessionTicker = null; // interval to update visible countdown
	let sessionDeadlineTs = 0; // timestamp when session should end

	function formatRemaining(ms) {
		var totalSeconds = Math.max(0, Math.ceil(ms / 1000));
		var minutes = Math.floor(totalSeconds / 60);
		var seconds = totalSeconds % 60;
		return String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
	}

	function updateSessionTimerUI() {
		if (!sessionActive) return;
		var remaining = sessionDeadlineTs - Date.now();
		if (remaining <= 0) {
			stopSession("Time's up");
			return;
		}
		sessionTimerEl.textContent = formatRemaining(remaining);
	}

	function restartSessionTimer() {
		if (!sessionActive) return;
		if (timerHandle) {
			clearTimeout(timerHandle);
			timerHandle = null;
		}
		if (sessionTicker) {
			clearInterval(sessionTicker);
			sessionTicker = null;
		}
		sessionDeadlineTs = Date.now() + 300000;
		sessionTimerEl.style.display = 'block';
		updateSessionTimerUI();
		timerHandle = setTimeout(function() { stopSession("Time's up"); }, 300000);
		sessionTicker = setInterval(updateSessionTimerUI, 200);
	}

	// Generate random 4-digit number (0000-9999)
	function generateRandom4Digit() {
		return Math.floor(Math.random() * 10000);
	}

	// Convert 4-digit number to string with padding
	function format4Digit(num) {
		return String(num).padStart(4, '0');
	}

	// Generate n random 4-digit numbers
	function generateNumbers(n) {
		const numbers = [];
		for (let i = 0; i < n; i++) {
			numbers.push(generateRandom4Digit());
		}
		return numbers;
	}

	function showNumbers() {
		currentNumbers = generateNumbers(currentN);
		const numbersText = currentNumbers.map(format4Digit).join(' ');
		numbersDisplayEl.innerHTML = numbersText;
		numbersDisplayEl.style.display = 'block';
		numbersDisplayEl.classList.remove('correct');
		inputSectionEl.classList.remove('visible');
		tapStartTs = Date.now();
		restartSessionTimer();
	}

	function stopSession(reasonText) {
		sessionActive = false;
		if (timerHandle) {
			clearTimeout(timerHandle);
			timerHandle = null;
		}
		if (sessionTicker) {
			clearInterval(sessionTicker);
			sessionTicker = null;
		}
		sessionTimerEl.style.display = 'none';
		startButton.textContent = reasonText || 'Time\'s up';
		startButton.disabled = true;
		startOverlay.style.display = 'grid';
	}

	function startSession() {
		sessionActive = true;
		if (timerHandle) { clearTimeout(timerHandle); timerHandle = null; }
		if (sessionTicker) { clearInterval(sessionTicker); sessionTicker = null; }
		showNumbers();
	}

	startButton.addEventListener('click', function() {
		startOverlay.style.display = 'none';
		startSession();
	});

	function sendTime(numbersStr, elapsedMs, n, time2, number2, errors) {
		try {
			var currentUser = localStorage.getItem('current_user') || null;
			fetch(HOST + '/api/write_time', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					number: Number(numbersStr),
					time: elapsedMs,
					mode: 5,
					n: n,
					time2: time2,
					number2: number2,
					errors: errors,
					user: currentUser
				})
			}).catch(function(){});
		} catch (e) {}
	}

	function showGateIfNeeded() {
		var existing = localStorage.getItem('current_user');
		if (!existing) {
			userGate.hidden = false;
			startButton.hidden = true;
			userInput.focus();
		} else {
			userGate.hidden = true;
			startButton.hidden = false;
		}
	}

	function updateUserLabel() {
		var u = localStorage.getItem('current_user') || '';
		currentUserLabel.textContent = u ? ('Current: ' + u) : 'Current: â€”';
	}

	function updateNLabel() {
		var n = localStorage.getItem('n_value') || '10';
		currentNLabel.textContent = 'Current n: ' + n;
	}

	function saveN() {
		var n = parseInt(nInput.value, 10);
		if (isNaN(n) || n < 1) n = 10;
		if (n > 100) n = 100;
		currentN = n;
		localStorage.setItem('n_value', String(n));
		updateNLabel();
	}

	function loadN() {
		var n = parseInt(localStorage.getItem('n_value'), 10);
		if (isNaN(n) || n < 1) n = 10;
		currentN = n;
		nInput.value = n;
		updateNLabel();
	}

	userSave.addEventListener('click', function() {
		var v = (userInput.value || '').trim();
		if (!v) return;
		localStorage.setItem('current_user', v);
		saveN();
		updateUserLabel();
		showGateIfNeeded();
	});

	userInput.addEventListener('keyup', function(e) {
		if (e.key === 'Enter') userSave.click();
	});

	nInput.addEventListener('keyup', function(e) {
		if (e.key === 'Enter') userSave.click();
	});

	document.addEventListener('DOMContentLoaded', function() {
		userInput.value = localStorage.getItem('current_user') || '';
		loadN();
		updateUserLabel();
		showGateIfNeeded();
		// Check API health once on load
		(function checkHealthOnce(){
			try {
				fetch(HOST + '/api/health', { method: 'GET', cache: 'no-store' })
					.then(function(r){ return r.ok ? r.json() : Promise.reject(); })
					.then(function(data){
						if (data && data.status === 'ok') {
							healthDot.style.background = '#2ecc71';
						} else {
							healthDot.style.background = '#ff3b30';
						}
					})
					.catch(function(){ healthDot.style.background = '#ff3b30'; });
			} catch (e) {
				healthDot.style.background = '#ff3b30';
			}
		})();
	});

	// Handle check button click
	checkButtonEl.addEventListener('click', function() {
		if (isTransitioning) return;

		// Compute recall time
		var recallTime = Math.max(0, Date.now() - recallStartTs);

		// Get user input and parse it
		var userInputValue = (numberInputEl.value || '').trim();
		var userNumbers = userInputValue.split(/\s+/).filter(function(s) { return s.length > 0; });

		// Pad user numbers to match currentN length
		while (userNumbers.length < currentN) {
			userNumbers.push('');
		}

		// Create combined strings for comparison
		var originalStr = currentNumbers.map(format4Digit).join('');
		var userStr = userNumbers.map(function(n) { return String(n).padStart(4, '0'); }).join('');

		// Count errors (digit by digit comparison)
		var errors = 0;
		var resultHtml = [];

		for (var i = 0; i < currentN; i++) {
			var originalNum = format4Digit(currentNumbers[i]);
			var userNum = (userNumbers[i] || '').padStart(4, '0');

			var numHtml = '';
			for (var j = 0; j < 4; j++) {
				var origDigit = originalNum[j];
				var userDigit = userNum[j] || '0';

				if (origDigit === userDigit) {
					numHtml += '<span class="digit-display correct">' + origDigit + '</span>';
				} else {
					numHtml += '<span class="digit-display incorrect">' + origDigit + '</span>';
					errors++;
				}
			}

			resultHtml.push(numHtml);
		}

		// Show result
		numbersDisplayEl.innerHTML = resultHtml.join(' ');
		inputSectionEl.classList.remove('visible');

		// Send event
		sendTime(originalStr, memorizationTime, currentN, recallTime, userStr, errors);

		// Wait 10 seconds, then show next numbers
		setTimeout(function() {
			numberInputEl.value = '';
			showNumbers();
			isTransitioning = false;
		}, 10000);
	});

	// Use pointer events so it works on both touch and mouse without double-firing
	window.addEventListener('pointerdown', function(ev) {
		if (!sessionActive) return;
		if (ev.isPrimary === false) return; // ignore secondary pointers
		if (isTransitioning) return;

		// Ignore taps on input section or start overlay
		if (inputSectionEl.contains(ev.target) || startOverlay.contains(ev.target)) return;

		// Only respond if numbers are visible (not during input phase)
		if (inputSectionEl.classList.contains('visible')) return;

		isTransitioning = true;

		// Compute elapsed from when the current numbers appeared (memorization time)
		memorizationTime = Math.max(0, Date.now() - tapStartTs);

		// Hide numbers, show input section
		numbersDisplayEl.style.display = 'none';
		inputSectionEl.classList.add('visible');
		numberInputEl.focus();

		// Start recall timer
		recallStartTs = Date.now();
		restartSessionTimer();
	});

	// Handle Enter key in number input
	numberInputEl.addEventListener('keyup', function(e) {
		if (e.key === 'Enter') checkButtonEl.click();
	});
})();
</script>
</body>
</html>
