<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Stats</title>
<style>
html, body {
	height: 100%;
}
body {
	margin: 0;
	padding: 0;
	background: #000;
	color: #fff;
	display: grid;
	grid-template-rows: auto 1fr auto;
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
	font-size: 16px;
	line-height: 1.5;
}

/* Topbar styling with improved spacing */
.topbar {
	display: flex;
	align-items: center;
	gap: 12px;
	padding: 16px 20px;
	position: sticky;
	top: 0;
	background: rgba(0,0,0,0.95);
	backdrop-filter: blur(10px);
	-webkit-backdrop-filter: blur(10px);
	z-index: 3;
	border-bottom: 1px solid #1a1a1a;
	box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Toggle switch with improved styling */
.switch {
	display: inline-block;
	position: relative;
	width: 52px;
	height: 30px;
	flex-shrink: 0;
}
.switch input { display: none; }
.switch .slider {
	position: absolute; 
	cursor: pointer; 
	top: 0; 
	left: 0; 
	right: 0; 
	bottom: 0;
	background: #444;
	border-radius: 999px; 
	transition: background-color .3s ease, box-shadow .3s ease;
	box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}
.switch .slider::before {
	content: ''; 
	position: absolute; 
	height: 24px; 
	width: 24px; 
	left: 3px; 
	top: 3px; 
	background: #fff;
	border-radius: 50%; 
	transition: transform .3s ease;
	box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.switch input:checked + .slider { 
	background: #0a84ff;
	box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 0 0 2px rgba(10,132,255,0.2);
}
.switch input:checked + .slider::before { transform: translateX(22px); }

.content {
	padding: 20px;
	overflow: auto;
}

/* Controls with responsive wrapping */
.controls { 
	display: flex; 
	align-items: center; 
	gap: 12px;
	flex-wrap: wrap;
}

/* Enhanced input styling */
.user-input { 
	font-size: 16px; 
	padding: 10px 14px; 
	border-radius: 8px; 
	border: 1px solid #333; 
	background: #0f0f0f; 
	color: #fff;
	transition: border-color .3s ease, box-shadow .3s ease;
	min-width: 180px;
}
.user-input:focus {
	outline: none;
	border-color: #0a84ff;
	box-shadow: 0 0 0 3px rgba(10,132,255,0.15);
}

/* Enhanced button styling */
.btn { 
	appearance: none; 
	border: none; 
	padding: 10px 16px; 
	border-radius: 8px; 
	font-weight: 600;
	font-size: 15px;
	cursor: pointer;
	transition: all .3s ease;
	box-shadow: 0 2px 4px rgba(0,0,0,0.2);
	white-space: nowrap;
}
.btn:hover {
	transform: translateY(-1px);
	box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
.btn:active {
	transform: translateY(0);
	box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.btn-primary { 
	background: linear-gradient(135deg, #0a84ff 0%, #0066d6 100%);
	color: #fff;
}
.btn-primary:hover {
	background: linear-gradient(135deg, #1a90ff 0%, #0072e6 100%);
}
.btn:not(.btn-primary) {
	background: #1a1a1a;
	color: #e0e0e0;
	border: 1px solid #333;
}
.btn:not(.btn-primary):hover {
	background: #252525;
	border-color: #444;
}

.user-label { 
	color: #aaa; 
	font-size: 14px; 
	margin-left: 4px;
	font-weight: 500;
}

/* Chart container with improved spacing */
.chart {
	margin-top: 24px;
	width: 100%;
	max-width: 1200px;
	margin-left: auto; 
	margin-right: auto;
}

/* Enhanced bar chart */
.bars {
	display: grid;
	grid-template-columns: repeat(100, 1fr);
	align-items: end;
	gap: 2px;
	height: 300px;
	background: #0b0b0b;
	border: 1px solid #222;
	border-radius: 10px;
	padding: 8px 8px 0 8px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.bar { 
	background: linear-gradient(to top, #2d7d46 0%, #3a9d5a 100%);
	border-radius: 2px 2px 0 0;
	transition: opacity .2s ease;
}
.bar:hover {
	opacity: 0.8;
}
.bar.zero { 
	background: #222;
	opacity: 0.5;
}

.xlabels { 
	display: grid; 
	grid-template-columns: repeat(100, 1fr); 
	font-size: 7px; 
	color: #888; 
	margin-top: 6px;
	font-weight: 500;
}

.stats { 
	margin-top: 16px; 
	color: #e0e0e0; 
	font-size: 15px; 
	text-align: center;
	font-weight: 500;
	padding: 12px;
	background: rgba(255,255,255,0.03);
	border-radius: 8px;
}

/* Enhanced table styles */
.table { 
	margin-top: 24px; 
	display: flex; 
	justify-content: center;
	overflow-x: auto;
	-webkit-overflow-scrolling: touch;
}
.table table { 
	border-collapse: collapse; 
	width: 100%; 
	max-width: 700px; 
	background: #0b0b0b; 
	border: 1px solid #222; 
	border-radius: 10px; 
	overflow: hidden;
	box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.table th, .table td { 
	padding: 12px 16px; 
	border-bottom: 1px solid #1a1a1a;
	font-size: 15px;
}
.table th { 
	text-align: left; 
	background: linear-gradient(to bottom, #161616 0%, #0f0f0f 100%); 
	color: #e0e0e0; 
	font-weight: 600;
	letter-spacing: 0.3px;
	text-transform: uppercase;
	font-size: 13px;
}
.table tr:hover td {
	background: #141414;
}
.table tr:nth-child(even) td { 
	background: #0e0e0e; 
}
.table tr:nth-child(even):hover td {
	background: #141414;
}
.table .num { 
	width: 100px; 
	color: #bbb;
	font-weight: 600;
	font-size: 16px;
}
.table .avg { 
	text-align: right; 
	color: #fff;
	font-weight: 500;
	font-variant-numeric: tabular-nums;
}
.table tr:last-child td {
	border-bottom: none;
}

/* Responsive design for tablets and mobile */
@media (max-width: 768px) {
	body {
		font-size: 15px;
	}
	
	.topbar {
		padding: 12px 16px;
		flex-wrap: wrap;
	}
	
	.controls {
		gap: 10px;
		width: 100%;
	}
	
	.user-input {
		flex: 1;
		min-width: 140px;
		font-size: 15px;
		padding: 10px 12px;
	}
	
	.btn {
		padding: 10px 14px;
		font-size: 14px;
		flex: 1;
		min-width: auto;
	}
	
	.user-label {
		width: 100%;
		margin-left: 0;
		font-size: 13px;
	}
	
	.content {
		padding: 16px 12px;
	}
	
	.chart {
		margin-top: 16px;
	}
	
	.bars {
		height: 200px;
		padding: 6px 6px 0 6px;
		gap: 1px;
	}
	
	.xlabels {
		font-size: 6px;
	}
	
	.stats {
		font-size: 14px;
		padding: 10px;
	}
	
	.table {
		margin-top: 16px;
	}
	
	.table th, .table td {
		padding: 10px 12px;
		font-size: 14px;
	}
	
	.table .num {
		font-size: 15px;
		width: 80px;
	}
}

/* Mobile-specific optimizations */
@media (max-width: 480px) {
	.topbar {
		padding: 10px 12px;
		gap: 8px;
	}
	
	.controls {
		gap: 8px;
	}
	
	.user-input {
		min-width: 100px;
		font-size: 14px;
		padding: 9px 10px;
	}
	
	.btn {
		padding: 9px 12px;
		font-size: 13px;
		min-width: 70px;
	}
	
	.content {
		padding: 12px 8px;
	}
	
	.bars {
		height: 180px;
		padding: 4px 4px 0 4px;
	}
	
	.xlabels {
		font-size: 5px;
		margin-top: 4px;
	}
	
	.stats {
		font-size: 13px;
		padding: 8px;
		margin-top: 12px;
	}
	
	.table th, .table td {
		padding: 8px 10px;
		font-size: 13px;
	}
	
	.table th {
		font-size: 12px;
	}
	
	.table .num {
		font-size: 14px;
		width: 70px;
	}
}

/* Large desktop screens */
@media (min-width: 1200px) {
	.content {
		padding: 24px;
	}
	
	.chart {
		max-width: 1400px;
	}
	
	.bars {
		height: 350px;
	}
	
	.table table {
		max-width: 800px;
	}
}
</style>
</head>
<body>
<div class="topbar">
	<div class="controls">
		<label class="switch" title="Numbers training mode">
			<input type="checkbox" id="modeToggle" />
			<span class="slider"></span>
		</label>
		<input id="userInput" class="user-input" type="text" placeholder="Set current user" />
		<span id="currentUserLabel" class="user-label"></span>
		<button id="saveUser" class="btn btn-primary">Save</button>
		<button id="refresh" class="btn">Refresh</button>
	</div>
</div>
<div class="content">
	<div class="chart">
		<div id="bars" class="bars"></div>
		<div id="xlabels" class="xlabels"></div>
		<div id="summary" class="stats"></div>
		<div id="tableWrap" class="table"></div>
	</div>
</div>
<script>
(function(){
	const HOST = 'https://superminor.ru';
	const modeToggle = document.getElementById('modeToggle');
	const userInput = document.getElementById('userInput');
	const saveUser = document.getElementById('saveUser');
	const refresh = document.getElementById('refresh');
	const currentUserLabel = document.getElementById('currentUserLabel');
	const barsEl = document.getElementById('bars');
	const xlabelsEl = document.getElementById('xlabels');
	const summaryEl = document.getElementById('summary');

	// default to mode 2 on load for stats
	modeToggle.checked = true; // checked => mode 2

	// initialize x-axis labels 00..99
	const labels = Array.from({length:100}, function(_,i){ return String(i).padStart(2, '0'); });
	labels.forEach(function(lbl, i){
		const d = document.createElement('div');
		d.textContent = lbl;
		// Yellow for even labels, white for odd
		d.style.color = (i % 2 === 0) ? '#f00' : '#fff';
		xlabelsEl.appendChild(d);
	});

	function getModeValue(){
		return modeToggle.checked ? 2 : 1; // reusing toggle style; checked => mode 2
	}

	function readCurrentUser(){
		return localStorage.getItem('current_user') || '';
	}

	function writeCurrentUser(v){
		if ((v||'').trim()) localStorage.setItem('current_user', v.trim());
	}

	function updateUserLabel(){
		const u = readCurrentUser();
		currentUserLabel.textContent = u ? ('Current: ' + u) : 'Current: —';
	}

	function fetchTimes(){
		const user = readCurrentUser();
		const mode = getModeValue();
		const params = new URLSearchParams();
		params.set('mode', String(mode));
		if (user) params.set('user', user);
		return fetch(HOST + '/api/get_time?' + params.toString()).then(function(r){ return r.json(); });
	}

	function computeAverages(rows){
		const sum = new Array(100).fill(0);
		const count = new Array(100).fill(0);
		rows.forEach(function(row){
			const num = Number(row.number);
			const t = Number(row.time);
			if (Number.isInteger(num) && num >= 0 && num <= 99 && Number.isFinite(t)){
				sum[num] += t;
				count[num] += 1;
			}
		});
		const avg = sum.map(function(s, i){ return count[i] ? (s / count[i]) : 0; });
		return { avg: avg, count: count };
	}

	function renderBars(avg){
		barsEl.innerHTML = '';
		const max = Math.max(1, Math.max.apply(null, avg));
		avg.forEach(function(value){
			const bar = document.createElement('div');
			bar.className = 'bar' + (value === 0 ? ' zero' : '');
			const h = (value / max) * 100;
			bar.style.height = h + '%';
			barsEl.appendChild(bar);
		});
	}

	function renderSummary(avg, count){
		const nonZero = avg.filter(function(v){ return v > 0; });
		const overall = nonZero.length ? Math.round(nonZero.reduce(function(a,b){ return a + b; }, 0) / nonZero.length) : 0;
		summaryEl.textContent = 'Average (non-zero): ' + overall + ' ms — Total samples: ' + count.reduce(function(a,b){return a+b;},0);
	}

	function renderTable(avg){
		var html = ['<table><thead><tr><th>Number</th><th style="text-align:right">Average (sec)</th></tr></thead><tbody>'];
		for (var i = 0; i < 100; i++) {
			var num = String(i).padStart(2, '0');
			var valSec = (((avg[i] || 0) / 1000).toFixed(2)) + ' sec';
			html.push('<tr><td class="num">' + num + '</td><td class="avg">' + valSec + '</td></tr>');
		}
		html.push('</tbody></table>');
		document.getElementById('tableWrap').innerHTML = html.join('');
	}

	function refreshAll(){
		fetchTimes().then(function(data){
			var rows = Array.isArray(data.rows) ? data.rows : [];
			var result = computeAverages(rows);
			renderBars(result.avg);
			renderSummary(result.avg, result.count);
			renderTable(result.avg);
		});
	}

	modeToggle.addEventListener('change', refreshAll);
	saveUser.addEventListener('click', function(){ writeCurrentUser(userInput.value); updateUserLabel(); refreshAll(); });
	refresh.addEventListener('click', refreshAll);

	document.addEventListener('DOMContentLoaded', function(){
		userInput.value = readCurrentUser();
		updateUserLabel();
		refreshAll();
	});
})();
</script>
</body>
</html>


