<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Random Image</title>
<style>
:root {
	--safe-top: env(safe-area-inset-top);
	--safe-right: env(safe-area-inset-right);
	--safe-bottom: env(safe-area-inset-bottom);
	--safe-left: env(safe-area-inset-left);
}
html, body {
	height: 100%;
}
body {
	margin: 0;
	padding: 0;
	background: #000;
	color: #fff;
	display: grid;
	place-items: center;
	overflow: hidden;
	touch-action: manipulation; /* prevent double-tap zoom */
	-webkit-tap-highlight-color: transparent;
}
.controls {
	position: fixed;
	top: calc(var(--safe-top) + 8px);
	right: calc(var(--safe-right) + 8px);
	z-index: 4;
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
.switch {
	display: inline-block;
	position: relative;
	width: 52px;
	height: 30px;
}
.switch input {
	display: none;
}
.switch .slider {
	position: absolute;
	cursor: pointer;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: #666;
	border-radius: 999px;
	transition: background-color .2s ease;
}
.switch .slider::before {
	content: '';
	position: absolute;
	height: 24px;
	width: 24px;
	left: 3px;
	top: 3px;
	background: #fff;
	border-radius: 50%;
	transition: transform .2s ease;
}
.switch input:checked + .slider {
	background: #0a84ff;
}
.switch input:checked + .slider::before {
	transform: translateX(22px);
}
.main {
	width: calc(100vw - var(--safe-left) - var(--safe-right));
	height: calc(100vh - var(--safe-top) - var(--safe-bottom));
	display: grid;
	place-items: center;
	position: relative; /* to anchor overlay over the image area */
}
img#photo {
	width: 100%;
	height: 100%;
	object-fit: contain;
	user-select: none;
	-webkit-user-drag: none;
}

#overlay {
	position: absolute; /* overlay directly over the image container */
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	display: none; /* toggled to grid when visible */
	place-items: center;
	background: rgba(0,0,0,0); /* ensure fully transparent */
	color: #fff;
	font-size: clamp(32px, 10vw, 96px);
	font-weight: 700;
	text-align: center;
	line-height: 1.2;
	letter-spacing: 0.5px;
	user-select: none;
	pointer-events: none; /* allow taps to pass through */
	z-index: 2; /* ensure overlay text is above the image */
}

/* Start screen overlay */
#startOverlay {
	position: fixed;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	display: grid;
	place-items: center;
	background: #000;
	z-index: 5;
}
.user-label {
	color: #ccc;
	font-size: 14px;
}

/* Health indicator dot */
#healthDot {
	position: fixed;
	top: calc(var(--safe-top) + 6px);
	left: calc(var(--safe-left) + 6px);
	width: 10px;
	height: 10px;
	border-radius: 50%;
	background: #ff3b30; /* default red until checked */
	box-shadow: 0 0 0 2px rgba(0,0,0,.4);
	z-index: 6;
}
.user-box {
	display: grid;
	gap: 12px;
	place-items: center;
}
.user-input {
	font-size: 18px;
	padding: 10px 12px;
	border-radius: 8px;
	border: 1px solid #444;
	background: #111;
	color: #fff;
	min-width: 240px;
}
.user-save {
	appearance: none;
	border: none;
	padding: 10px 16px;
	border-radius: 8px;
	font-size: 16px;
	font-weight: 700;
	cursor: pointer;
	background: #2d7d46;
	color: #fff;
}
.user-label {
	color: #ccc;
	font-size: 14px;
}
.start-button {
	appearance: none;
	border: none;
	padding: 14px 28px;
	border-radius: 10px;
	font-size: 20px;
	font-weight: 700;
	cursor: pointer;
	background: #0a84ff;
	color: #fff;
}
.start-button:disabled {
	background: #333;
	cursor: default;
}
</style>
</head>
<body>
	<div class="main">
		<img id="photo" alt="Random" src="" />
	</div>
	<div id="overlay" aria-hidden="true"></div>
	<div id="startOverlay">
		<div id="userGate" class="user-box" hidden>
			<div>Enter user name</div>
			<input id="userInput" class="user-input" type="text" placeholder="Your name" />
			<span id="currentUserLabel" class="user-label"></span>
			<button id="userSave" class="user-save">Continue</button>
		</div>
		<button id="startButton" class="start-button" hidden>Start</button>
	</div>
	<div id="healthDot" aria-hidden="true"></div>
	<div class="controls" title="Numbers training mode">
		<label class="switch">
			<input type="checkbox" id="modeToggle" />
			<span class="slider"></span>
		</label>
	</div>
<script>
(function() {
	// Backend host for API calls
	const HOST = 'https://superminor.ru';

	// Images 00..99 (assumes .png for all)
	const imageNames = Array.from({ length: 100 }, function(_, i) {
		const base = String(i).padStart(2, '0');
		return base + '.png';
	});

	const basePath = 'img/';
	const imgEl = document.getElementById('photo');
	const overlayEl = document.getElementById('overlay');
	const modeToggle = document.getElementById('modeToggle');
	const controlsEl = document.querySelector('.controls');
	const startOverlay = document.getElementById('startOverlay');
	const startButton = document.getElementById('startButton');
	const userGate = document.getElementById('userGate');
	const userInput = document.getElementById('userInput');
	const userSave = document.getElementById('userSave');
	const currentUserLabel = document.getElementById('currentUserLabel');
	const healthDot = document.getElementById('healthDot');
	let lastIndex = -1;
	let isTransitioning = false;
	let isNumberMode = true; // default Mode 2 (number first)
	let pendingIndex = null; // next number's image index in number mode
	const preloadMap = new Map();

	// Session timing & per-stimulus timing
	let sessionActive = false;
	let tapStartTs = 0; // resets whenever a new number/image is shown
	let timerHandle = null;

	function preloadImage(src) {
		if (preloadMap.has(src)) return preloadMap.get(src);
		let resolveFn;
		const p = new Promise(function(resolve) { resolveFn = resolve; });
		const temp = new Image();
		function done() { resolveFn(); }
		if (typeof temp.decode === 'function') {
			temp.src = src;
			temp.decode().then(done).catch(done);
		} else {
			temp.onload = done;
			temp.onerror = done;
			temp.src = src;
		}
		preloadMap.set(src, p);
		return p;
	}

	function getBaseName(fileName) {
		return fileName.replace(/\.[^.]+$/, '');
	}

	function pickNextIndex() {
		if (imageNames.length === 1) return 0;
		let idx;
		do {
			idx = Math.floor(Math.random() * imageNames.length);
		} while (idx === lastIndex);
		lastIndex = idx;
		return idx;
	}

	function pickFreshIndex() {
		if (imageNames.length === 1) return 0;
		let idx;
		do {
			idx = Math.floor(Math.random() * imageNames.length);
		} while (idx === lastIndex);
		return idx; // does NOT mutate lastIndex
	}

	function showRandomImage() {
		const idx = pickNextIndex();
		imgEl.src = basePath + imageNames[idx];
		// start per-tap timer when stimulus (image) is visible
		tapStartTs = Date.now();
	}


	function showNumberForIndex(idx) {
		const nameToShow = getBaseName(imageNames[idx]);
		overlayEl.textContent = nameToShow;
		overlayEl.style.color = '#000';
		overlayEl.style.background = '#fff';
		overlayEl.style.display = 'grid';
		// Preload the corresponding image while the number is visible
		const src = basePath + imageNames[idx];
		preloadImage(src);
		// start per-tap timer when stimulus (number) is visible
		tapStartTs = Date.now();
	}

	function enterNumberMode() {
		if (isTransitioning) return;
		isNumberMode = true;
		if (pendingIndex === null) pendingIndex = pickFreshIndex();
		showNumberForIndex(pendingIndex);
	}

	function exitNumberMode() {
		isNumberMode = false;
		overlayEl.style.display = 'none';
		overlayEl.style.background = 'rgba(0,0,0,0)';
		overlayEl.style.color = '#fff';
		pendingIndex = null;
		if (lastIndex < 0) {
			showRandomImage();
		}
	}

	modeToggle.addEventListener('change', function() {
		if (modeToggle.checked) {
			enterNumberMode();
		} else {
			exitNumberMode();
		}
	});

	function stopSession(reasonText) {
		sessionActive = false;
		if (timerHandle) {
			clearTimeout(timerHandle);
			timerHandle = null;
		}
		startButton.textContent = reasonText || 'Time\'s up';
		startButton.disabled = true;
		startOverlay.style.display = 'grid';
	}

	function startSession() {
		sessionActive = true;
		if (timerHandle) clearTimeout(timerHandle);
		timerHandle = setTimeout(function() {
			stopSession("Time's up");
		}, 60000);
		// Default to mode 2 (number first)
		modeToggle.checked = true;
		enterNumberMode();
	}

	startButton.addEventListener('click', function() {
		startOverlay.style.display = 'none';
		startSession();
	});

	function sendTime(numberStr, elapsedMs, modeValue) {
		try {
			var currentUser = localStorage.getItem('current_user') || null;
			fetch(HOST + '/api/write_time', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ number: Number(numberStr), time: elapsedMs, mode: modeValue, user: currentUser })
			}).catch(function(){});
		} catch (e) {}
	}

	function showGateIfNeeded() {
		var existing = localStorage.getItem('current_user');
		if (!existing) {
			userGate.hidden = false;
			startButton.hidden = true;
			userInput.focus();
		} else {
			userGate.hidden = true;
			startButton.hidden = false;
		}
	}

	function updateUserLabel() {
		var u = localStorage.getItem('current_user') || '';
		currentUserLabel.textContent = u ? ('Current: ' + u) : 'Current: â€”';
	}

	userSave.addEventListener('click', function() {
		var v = (userInput.value || '').trim();
		if (!v) return;
		localStorage.setItem('current_user', v);
		updateUserLabel();
		showGateIfNeeded();
	});

	userInput.addEventListener('keyup', function(e) {
		if (e.key === 'Enter') userSave.click();
	});

	document.addEventListener('DOMContentLoaded', function() {
		userInput.value = localStorage.getItem('current_user') || '';
		updateUserLabel();
		showGateIfNeeded();
		// Check API health once on load
		(function checkHealthOnce(){
			try {
				fetch(HOST + '/api/health', { method: 'GET', cache: 'no-store' })
					.then(function(r){ return r.ok ? r.json() : Promise.reject(); })
					.then(function(data){
						if (data && data.status === 'ok') {
							healthDot.style.background = '#2ecc71';
						} else {
							healthDot.style.background = '#ff3b30';
						}
					})
					.catch(function(){ healthDot.style.background = '#ff3b30'; });
			} catch (e) {
				healthDot.style.background = '#ff3b30';
			}
		})();
	});

	// Use pointer events so it works on both touch and mouse without double-firing
	window.addEventListener('pointerdown', function(ev) {
		if (!sessionActive) return;
		if (ev.isPrimary === false) return; // ignore secondary pointers
		// Ignore taps on the controls (e.g., the slider)
		if (controlsEl && controlsEl.contains(ev.target)) return;
		if (isTransitioning) return;
		isTransitioning = true;

		// Compute elapsed from when the current stimulus appeared
		var tapElapsed = Math.max(0, Date.now() - tapStartTs);
		var modeValue = isNumberMode ? 2 : 1;
		var numberForEvent = null;
		if (isNumberMode) {
			if (pendingIndex === null) pendingIndex = pickFreshIndex();
			numberForEvent = getBaseName(imageNames[pendingIndex]);
		} else {
			if (lastIndex >= 0) numberForEvent = getBaseName(imageNames[lastIndex]);
		}

		if (isNumberMode) {
			// In number mode: currently showing a number on white background.
			if (pendingIndex === null) pendingIndex = pickFreshIndex();
			// Show its image for 0.5s, then next number.
			// Avoid flicker: keep white overlay until the image is decoded, then swap and hide overlay.
			const src = basePath + imageNames[pendingIndex];
			preloadImage(src).then(function() {
				imgEl.src = src;
				overlayEl.style.display = 'none';
				lastIndex = pendingIndex;
				setTimeout(function() {
					pendingIndex = pickFreshIndex();
					showNumberForIndex(pendingIndex);
					isTransitioning = false;
				}, 500);
			});
			// Send timing for this tap
			if (numberForEvent !== null) {
				sendTime(numberForEvent, tapElapsed, modeValue);
			}
			return;
		}

		// Normal mode: show current image name for 0.5s, then next image
		if (lastIndex < 0) {
			showRandomImage();
			isTransitioning = false;
		} else {
			const currentFile = imageNames[lastIndex];
			const nameToShow = getBaseName(currentFile);
			overlayEl.textContent = nameToShow;
			overlayEl.style.color = '#fff';
			overlayEl.style.background = 'rgba(0,0,0,0)';
			overlayEl.style.display = 'grid';
			// Send timing for this tap (name shown for current image)
			if (numberForEvent !== null) {
				sendTime(numberForEvent, tapElapsed, modeValue);
			}
			setTimeout(function() {
				overlayEl.style.display = 'none';
				showRandomImage();
				isTransitioning = false;
			}, 500);
		}

	});
})();
</script>
</body>
</html>


